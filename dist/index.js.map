{"version":3,"sources":["../index.js"],"names":["create","keyRegex","specialFields","arrayMethods","split","copy","Symbol","dbWrapper","from","collection","callback","col","db","arguments","length","translateField","field","translateValue","value","String","findAllPossibles","traverse","node","parent","index","children","some","child","childIndex","orNodes","root","type","id","__children","push","result","posible","increased","i","slice","forEach","parseCondition","Object","keys","condition","key","Array","map","exec","op","Error","frontCode","endChar","endcode","fromCharCode","charCodeAt","queryable","unsubscribes","limit","startAt","orderBy","where","lastGet","lastDocs","compiledQueries","processResults","results","docs","count","undefined","doc","values","modify","Promise","resolve","then","batch","firestore","commit","buildQueries","noCache","q","reduce","order","JSON","parse","stringify","p","clone","overwriteData","assign","query","data","options","Function","onSnapshot","copyOfUnsubscribes","unsubscribe","get","newWhere","conditions","fields","newOrderBy","source","promises","all","x","queries","startAfter","docsOrData","applyToResultSet","set","ref","update","delete","method","args","newSpecialFields"],"mappings":"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","file":"index.js","sourcesContent":["const keyRegex = /^\\s*([^^<>=\\s]+)\\s*(<>|<|>|<=|>=|==|=|\\^=)?\\s*$/;\r\nconst specialFields = {\r\n  '@id': '__name__'\r\n};\r\nconst arrayMethods = 'slice reduce map filter'.split(/\\s+/);\r\nconst copy = Symbol('copy');\r\nconst dbWrapper = db => {\r\n  return {\r\n    from(collection, callback) {\r\n      const col = create(db.collection(collection));\r\n      if (arguments.length < 2) {\r\n        return col;\r\n      }\r\n      callback(col);\r\n      return this;\r\n    }\r\n  };\r\n};\r\n\r\nconst translateField = field => specialFields[field] || field;\r\nconst translateValue = (field, value) =>\r\n  field === '@id' ? String(value) : value;\r\n\r\n/**\r\n * algorithm:\r\n * collect all or node, then put them into the list\r\n * each or node contains childIndex (from 0 - number of child)\r\n * we perform infinite loop until no child index can be increased\r\n * for sample:\r\n *  A (2) B (3)  are nodes and its chid number (number insde parentheses)\r\n *  0     0 are values/child indexes\r\n * for each child index, if we can incease it by 1, we reset prev indexes to 0,\r\n * unless we try to increase next child index,\r\n * if no child index can be increased the loop is end\r\n *  A  B\r\n *  0  0\r\n *  1  0\r\n *  0  1\r\n *  1  1\r\n *  0  2\r\n *  1  2\r\n *  totally 6 possible generated\r\n */\r\nconst findAllPossibles = root => {\r\n  function traverse(node, callback, parent, index) {\r\n    if (callback(node, parent, index)) return true;\r\n    if (node.children && node.children.length) {\r\n      node.children.some((child, childIndex) =>\r\n        traverse(child, callback, node, childIndex)\r\n      );\r\n    }\r\n  }\r\n\r\n  const orNodes = [];\r\n\r\n  // create indexes\r\n  traverse(root, (node, parent, index) => {\r\n    node.parent = () => parent;\r\n    if (node.type === 'or') {\r\n      node.id = orNodes.length;\r\n      node.__children = node.children;\r\n      node.childIndex = 0;\r\n      orNodes.push(node);\r\n    }\r\n  });\r\n  const result = [];\r\n  let posible;\r\n  while (true) {\r\n    traverse(root, node => {\r\n      if (node.type === 'or') {\r\n        node.children = [node.__children[node.childIndex]];\r\n      }\r\n      if (node.type !== 'or' && node.type !== 'and') {\r\n        if (!posible) {\r\n          posible = [];\r\n          result.push(posible);\r\n        }\r\n        posible.push(node);\r\n      }\r\n    });\r\n    posible = null;\r\n    let increased = false;\r\n    // increase possible number\r\n    for (let i = 0; i < orNodes.length; i++) {\r\n      // can increase\r\n      const node = orNodes[i];\r\n      if (node.childIndex + 1 < node.__children.length) {\r\n        node.childIndex++;\r\n        // reset prev nodes\r\n        orNodes.slice(0, i).forEach(node => (node.childIndex = 0));\r\n        increased = true;\r\n        break;\r\n      }\r\n    }\r\n    if (!increased) break;\r\n  }\r\n\r\n  return result;\r\n};\r\n\r\nconst parseCondition = condition => {\r\n  const result = [];\r\n  Object.keys(condition).forEach(key => {\r\n    let value = condition[key];\r\n    if (key === 'or') {\r\n      const children = [];\r\n      if (value instanceof Array) {\r\n        children.push(...value);\r\n      } else {\r\n        Object.keys(value).forEach(field => {\r\n          children.push({ [field]: value[field] });\r\n        });\r\n      }\r\n\r\n      result.push({\r\n        type: 'or',\r\n        children: children.map(child => ({\r\n          type: 'and',\r\n          children: parseCondition(child)\r\n        }))\r\n      });\r\n    } else {\r\n      // parse normal criteria\r\n      let [, field, op = '=='] = keyRegex.exec(key) || [];\r\n      if (!field) {\r\n        throw new Error('Invalid criteria ' + key);\r\n      }\r\n      if (op === '=' || op === '===') {\r\n        op = '==';\r\n      }\r\n      if (value instanceof Array) {\r\n        if (op !== '==') {\r\n          throw new Error('Unsupported ' + op + ' for Array');\r\n        }\r\n        result.push({\r\n          type: 'or',\r\n          children: value.map(value => ({ field, type: op, value }))\r\n        });\r\n      } else {\r\n        if (op === '<>' || op === '!=' || op === '!==') {\r\n          result.push({\r\n            type: 'or',\r\n            children: [{ field, type: '>', value }, { field, type: '<', value }]\r\n          });\r\n        }\r\n        // process startsWith operator\r\n        else if (op === '^=') {\r\n          value = String(value);\r\n          const length = value.length;\r\n          const frontCode = value.slice(0, length - 1);\r\n          const endChar = value.slice(length - 1, value.length);\r\n          const endcode =\r\n            frontCode + String.fromCharCode(endChar.charCodeAt(0) + 1);\r\n          result.push(\r\n            { field, type: '>=', value },\r\n            { field, type: '<', value: endcode }\r\n          );\r\n        } else {\r\n          result.push({ field, type: op, value });\r\n        }\r\n      }\r\n    }\r\n  });\r\n  return result;\r\n};\r\n\r\nexport default function create(queryable, collection) {\r\n  if (queryable.collection) {\r\n    if (collection) {\r\n      queryable = queryable.collection(collection);\r\n    } else {\r\n      return dbWrapper(queryable);\r\n    }\r\n  }\r\n  const unsubscribes = [];\r\n  let limit = 0;\r\n  let startAt;\r\n  let orderBy = [];\r\n  let where = [];\r\n  let lastGet, lastDocs;\r\n  let compiledQueries;\r\n\r\n  function processResults(results) {\r\n    const docs = {};\r\n    let count = 0;\r\n    lastDocs = results.map(\r\n      result => (result ? result.docs[result.docs.length - 1] : undefined)\r\n    );\r\n    results.some(result => {\r\n      if (!result) return;\r\n      result.forEach(doc => {\r\n        if (limit && count >= limit) return;\r\n        if (!(doc.id in docs)) {\r\n          count++;\r\n        }\r\n        docs[doc.id] = doc;\r\n      });\r\n      return limit && count >= limit;\r\n    });\r\n    return Object.values(docs);\r\n  }\r\n\r\n  function modify(docs, callback) {\r\n    return Promise.resolve(docs).then(docs => {\r\n      const batch = queryable.firestore.batch();\r\n      for (let doc of docs) {\r\n        callback(batch, doc);\r\n      }\r\n      return batch.commit();\r\n    });\r\n  }\r\n\r\n  function buildQueries(noCache) {\r\n    if (!noCache && compiledQueries) return compiledQueries;\r\n\r\n    if (!where.length) {\r\n      let q = queryable;\r\n      if (limit) {\r\n        q = q.limit(limit);\r\n      }\r\n      if (startAt !== undefined) {\r\n        q = q.startAt(startAt);\r\n      }\r\n\r\n      return [orderBy.reduce((q, order) => q.orderBy(...order), q)];\r\n    }\r\n\r\n    // should copy where before process\r\n    const posible = findAllPossibles(\r\n      JSON.parse(\r\n        JSON.stringify({\r\n          type: 'and',\r\n          children: where\r\n        })\r\n      )\r\n    );\r\n\r\n    return (compiledQueries = posible.map(p => {\r\n      return p.reduce((q, node) => {\r\n        if (limit) {\r\n          q = q.limit(limit);\r\n        }\r\n        if (startAt !== undefined) {\r\n          q = q.startAt(startAt);\r\n        }\r\n        return orderBy\r\n          .reduce((q, order) => q.orderBy(...order), q)\r\n          .where(\r\n            translateField(node.field),\r\n            node.type,\r\n            translateValue(node.field, node.value)\r\n          );\r\n      }, queryable);\r\n    }));\r\n  }\r\n\r\n  function clone(overwriteData) {\r\n    return create(queryable)[copy](\r\n      Object.assign(\r\n        {\r\n          limit,\r\n          where,\r\n          orderBy,\r\n          startAt\r\n        },\r\n        overwriteData\r\n      )\r\n    );\r\n  }\r\n\r\n  const query = {\r\n    [copy](data) {\r\n      limit = data.limit;\r\n      where = data.where;\r\n      orderBy = data.orderBy;\r\n      startAt = data.startAt;\r\n      return this;\r\n    },\r\n    subscribe(options, callback) {\r\n      if (options instanceof Function) {\r\n        callback = options;\r\n        options = {};\r\n      }\r\n      unsubscribes.push(\r\n        ...buildQueries().map(queryable =>\r\n          queryable.onSnapshot(options, callback)\r\n        )\r\n      );\r\n      return this;\r\n    },\r\n    unsubscribeAll() {\r\n      const copyOfUnsubscribes = unsubscribes.slice();\r\n      unsubscribes.length = 0;\r\n      copyOfUnsubscribes.forEach(unsubscribe => unsubscribe());\r\n      return this;\r\n    },\r\n    limit(count) {\r\n      return clone({ limit: count });\r\n    },\r\n    first() {\r\n      return this.limit(1)\r\n        .get()\r\n        .then(results => {\r\n          return results[0];\r\n        });\r\n    },\r\n    where(...conditions) {\r\n      const newWhere = where.slice();\r\n      conditions.forEach(condition =>\r\n        newWhere.push(...parseCondition(condition))\r\n      );\r\n      return clone({\r\n        where: newWhere\r\n      });\r\n    },\r\n    orderBy(fields) {\r\n      const newOrderBy = orderBy.slice();\r\n      Object.keys(fields).forEach(field =>\r\n        newOrderBy.push([field, fields[field]])\r\n      );\r\n      return clone({\r\n        orderBy: newOrderBy\r\n      });\r\n    },\r\n    get: function get({ source } = {}) {\r\n      const promises = buildQueries().map(queryable => queryable.get(source));\r\n      return (lastGet = Promise.all(promises).then(processResults));\r\n    },\r\n    data(options) {\r\n      return this.get(options).then(results => results.map(x => x.data()));\r\n    },\r\n    next(options = {}) {\r\n      const { source } = options;\r\n      if (lastGet) {\r\n        return (lastGet = lastGet.then(docs => {\r\n          if (!docs.length) return [];\r\n          const queries = buildQueries();\r\n          const promises = queries.map((queryable, index) => {\r\n            if (!lastDocs[index]) return undefined;\r\n            return queryable.startAfter(lastDocs[index]).get(source);\r\n          });\r\n          return Promise.all(promises).then(processResults);\r\n        }));\r\n      }\r\n      return this.get(options);\r\n    },\r\n    set(docsOrData, applyToResultSet) {\r\n      if (applyToResultSet) {\r\n        return modify(this.get(), (batch, doc) =>\r\n          batch.set(doc.ref, docsOrData)\r\n        );\r\n      }\r\n      return modify(\r\n        Object.keys(docsOrData).map(id => queryable.doc(String(id))),\r\n        (batch, doc) => batch.set(doc, docsOrData[doc.id])\r\n      );\r\n    },\r\n    update(docsOrData, applyToResultSet) {\r\n      if (applyToResultSet) {\r\n        return modify(this.get(), (batch, doc) =>\r\n          batch.update(doc.ref, docsOrData)\r\n        );\r\n      }\r\n      return modify(\r\n        Object.keys(docsOrData).map(id => queryable.doc(String(id))),\r\n        (batch, doc) => batch.update(doc, docsOrData[doc.id])\r\n      );\r\n    },\r\n    remove() {\r\n      return modify(this.get(), (batch, doc) => batch.delete(doc.ref));\r\n    }\r\n  };\r\n\r\n  arrayMethods.forEach(method => {\r\n    query[method] = (...args) =>\r\n      query.get().then(results => results[method](...args));\r\n  });\r\n\r\n  return query;\r\n}\r\n\r\nObject.assign(create, {\r\n  fields(newSpecialFields) {\r\n    Object.assign(specialFields, newSpecialFields);\r\n    return this;\r\n  }\r\n});\r\n"]}